\documentclass[11pt]{amsart}
\usepackage{amssymb,amsfonts}
\usepackage{euscript,mathrsfs}
\usepackage{latexsym}
\usepackage{xspace}
\usepackage{amscd}
\usepackage{amsmath}
\usepackage{color}
\usepackage{cite}
\usepackage{graphicx}
\usepackage[utf8]{inputenc}
\usepackage{amsmath,amsthm,amsopn,graphicx,microtype}
\usepackage{url}

\theoremstyle{plain}% default
\newtheorem{thm}{Theorem}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem*{cor}{Corollary}
\newtheorem{algorithm}{Algorithm}

\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{exmp}[thm]{Example}

\theoremstyle{remark}
\newtheorem*{rem}{Remark}
\newtheorem*{note}{Note}
\newtheorem{case}{Case}

\newcommand{\Mac}{Macaulay2\xspace}
\newcommand{\SOS}{\textsc{SOS}\xspace}

\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}

\begin{document}

\title[SOS.m2]{Sums of squares in Macaulay2}

\author{Diego Cifuentes}
\address{Massachusetts Institute of Technology \\ Cambridge, MA, USA}
\email{diegcif@mit.edu}

\author{Thomas Kahle}
\address{Otto-von-Guericke University \\ Magdeburg, Germany}
\email{thomas.kahle@ovgu.de}

\author{Pablo A. Parrilo}
\address{Massachusetts Institute of Technology \\ Cambridge, MA, USA}
\email{parrilo@mit.edu}


\begin{abstract}
  The package \SOS implements sums of squares (SOS) decompositions in
  Macaulay2.  It is based on methods to rationalize SOS decompositions
  due to Parrilo and Peyrl and features a data type for SOS
  decompositions, support for external SDP solvers, and optimization
  over varieties.
\end{abstract}

\maketitle

% Some topics
% 1) brief introduction to SOS, nonnegativity, polynomial optimization
% 2) computing SOS decompositions (Motzkin, Robinson, Lax-Lax)
% 2) computing SOS decompositions of ternary forms (Harris)
% 3) parametrized SOS problems
% 4) SOS optimization (lowerBound, lasserreHierarchy)

\section{Introduction}

Let $k = \QQ$ or $k = \RR$ denote the rational or real numbers and let $R = k[x_{1},\dots,x_{n}]$ be the polynomial ring.  
An element $f\in R$ is \emph{nonnegative} if $f(x) \ge 0$ for all $x \in \RR^{n}$.  
The element $f$ is a \emph{sum of squares} or \emph{SOS} if there exist $h_{1},\dots,h_{m} \in R$ such that $f=\sum_{i=1}^{m}h_{i}^{2}$.
Clearly, an SOS polynomial is nonnegative, but not every nonnegative polynomial is SOS.
Classically, Hilbert characterized in which cases sums of squares coincide with nonnegative polynomials as univariate polynomials, quadratic polynomials and bivariate quartics.  
For an introduction to the area we recommend~\cite{scheiderer2009positivity,blekherman2012semidefinite}.

The purpose of the \SOS package is to deal with sums of squares in Macaulay2.
A particular focus is on trying to find rational SOS decompositions of polynomials with rational coefficients (whenever they exist).

The package contains the data type \verb|SOSPoly| to store SOS decompositions and perform basic operations on them.
The most basic method is \verb|solveSOS|.
It takes a polynomial and tries to write it as a sum of squares:
{\small
\verb|solveSOS|:
\begin{verbatim}
i6 : R = QQ[x,y];
i7 : f = 2*x^4+5*y^4-2*x^2*y^2+2*x^3*y;
i8 : sosPoly solveSOS f
Executing CSDP
Status: SDP solved, primal-dual feasible
o8 = coeffs: {5, 43/20, 231773/344000}              
     gens: {- 83/200 x^2  + y^2 , 20/43 x^2  + x*y, x^2 }
\end{verbatim}
}
This output has been reformatted for the paper, but contains the same information as the actual output.
The type \verb|SOSPoly| stores a sum of squares $f$ as coefficients $\lambda_{1},\dots,\lambda_{k}$ (under \verb|coeffs|) and polynomials $h_{1},\dots,h_{k}$ (under \verb|gens|) such that $f = \sum_{i=1}^{k}\lambda_{i}h_{i}^{2}$.
Storing the coefficients separately avoids the necessity to adjoin square roots to~$\QQ$.

In the above example the package is configured to use the SDP solver CSDP which is called by \verb|solveSOS|.
The SOS decomposition of the input polynomial solves an SDP numerically and then rounds the result to obtain a rational SOS decomposition.
The return value of \verb|solveSOS| is an object \verb|SDPresult| which contains details about the numerical computation.
Then \verb|sosPoly| extracts the SOS.
In this case there are three squares:
\[
  f = 5(-\tfrac{83}{200} x^{2}+y^{2})^{2} + \tfrac{43}{20}
  (\tfrac{20}{43}x^{2} + xy)^{2} + \tfrac{231773}{344000} (x^{2})^{2}
\]
This decomposition is not the simplest one, but it is fully rational. 
Simplifications can be done in post-processing.

The package also allows to compute SOS decompositions in quotient rings.
This can be useful to prove nonnegativity of a polynomial on a variety.  
The following example is taken from~\cite{parrilo2005exploiting}.  
Consider the problem of proving that the polynomial $f = 10-x^2-y$ is nonnegative on the circle defined by $g = x^2 + y^2 - 1$.
To do this we check if the image of $f$ in $\QQ[x,y]/g$ is a sum-of-squares.
For such a computation, a degree bound must be given by the user as it is not a priori obvious how to choose a monomial basis.
This is the second argument to \verb|solveSOS| in the following example.
{\small
\begin{verbatim}
i2 : R = QQ[x,y]/ideal(x^2 + y^2 - 1);
i3 : f = 10-x^2-y;
i4 : sosPoly solveSOS (f, 2)
Executing CSDP
Status: SDP solved, primal-dual feasible
o4 = coeffs: {7, 6, 83/28}      
     gens: {y - 1/14, x, 1}
\end{verbatim}
}
The above decomposition involves three squares.
It is possible to obtain a decomposition with only two squares by setting the option \verb|TraceObj=>true|.
This option tells \Mac to use the matrix trace as an objective function for the SDP.
{\small
\begin{verbatim}
i5 : sosPoly solveSOS (f, 2, TraceObj=>true)
Executing CSDP
Status: SDP solved, primal-dual feasible
o5 = coeffs: {9, 35/36}      
     gens: {- 1/18 y + 1, y} 
\end{verbatim}
}

% \subsection{History of the package}
% The new version of \SOS was developed starting with version 1.5 of the
% \SOS package due to Parrilo and Peyrl~\cite{peyrl2008computing}.
% The idea of rational reconstruction of SOS decompositions goes back to
% that work.

\subsection*{A word on SDP Solvers}
The \SOS package relies on numerical SDP solvers for SOS decompositions.  
While it does have a built in solver in the \Mac language, 
reasonable examples require an external solver.
At the moment the package has interfaces to the open source solvers CSDP~\cite{borchers1999csdp} and SDPA~\cite{yamashita2003implementation}.
In our experience CSDP gives the best results.
We refer to the package documentation on how to select the solver.

\subsection*{A small library of nonnegative forms}
The package implements a small library of interesting nonnegative forms that have appeared in the literature in the function  \verb|nonnegativeForm|.
It takes the name of a polynomial and a suitable target ring.
The following arguments are possible: \verb|Motzkin|, \verb|Robinson|, \verb|Schmuedgen|, \verb|Lax-Lax|, \verb|Choi-Lam|, \verb|Scheiderer|, and \verb|Harris|.
The package documentation contains more information about these polynomials.
For a concrete example, the Scheiderer polynomial admits an SOS decomposition over the reals, but not over the rationals.
{\small
\begin{verbatim}
i3 : R = QQ[x,y,z]
i4 : nonnegativeForm ("Scheiderer", R)

      4      3    4     2          2      2 2      3      3    4
o4 = x  + x*y  + y  - 3x y*z - 4x*y z + 2x z  + x*z  + y*z  + z

\end{verbatim}
}

\section{Sums of squares in ideals}
Let $I \subset k[x_{1},\dots,x_{n}]$ be an ideal.  The \SOS package can be used to find a sum of squares in~$I$.
Of course every ideal contains the squares of its generators.
The aim is to find low degree sums of squares.
An alternative formulation of the same problem is to consider the quotient $S = k[x_{1},\dots,x_{n}]/I$ and write $0\in S$ as a sum of squares.
Both formulations of the problem are available in the \SOS package.
The first takes a one row matrix of polynomials and tries to find a sum of squares that is a polynomial combination of them.
For this, \verb|sosInIdeal| needs to be called with a matrix of polynomials and a degree bound on the desired sum of squares:
{\small
\begin{verbatim}
i1 : R = QQ[x,y,z];
i2 : h = matrix {{x^2+y^2+y, y-z^2}};
i3 : (sol,mult) = sosInIdeal (h, 2);
i4 : sosPoly sol
o4 = coeffs: {63/4, 63/4, 63/4}
     gens: {x, y, z}
i5 : h * mult == sumSOS sosPoly sol
\end{verbatim}
}
The same computation can be carried out in the quotient ring.
In this case the argument to \verb|sosInIdeal| is simply the quotient ring.
{\small
\begin{verbatim}
i6 : S = R/ideal h;
i7 : sol = sosInIdeal (S, 2);
i8 : sumSOS sosPoly sol
o8 = 0
\end{verbatim}
}

\section{SOS decomposition of ternary forms}

Hilbert showed that any nonnegative form $f\in k[x,y,z]$ can be decomposed as a quotient of sums of squares.
We can obtain this decomposition by iteratively calling \verb|sosInIdeal|.
Specifically, one can find a multiplier $q_{1}$ such that $q_{1}f$ is SOS.
Since $q_1$ is also nonnegative, we can then search for a multiplier $p_{1}$ such that $p_{1}q_{1}$ is SOS, and so on.
The main observation is that the necessary degree of $p_{1}$ is lower than that of $q_{1}$.
Therefore, this procedure terminates, and we can write $f$ as
\[
  f = \frac{p_{1}\cdots p_{s}}{q_{1}\cdots q_{t}} \qquad \text {
    $p_{i},q_{i}$ SOS}.
\]
This method is implemented in the \SOS package as \verb|sosdecTernary|.  
Here we apply it to the Motzkin polynomial.
{\small
\begin{verbatim}
i2 : R = QQ[x,y,z]
i3 : f = nonnegativeForm ("Motzkin", {x,y,z})
      4 2    2 4     2 2 2    6
o3 = x y  + x y  - 3x y z  + z
i4 : (nums,dens) = sosdecTernary f;
Executing CSDP
i5 : first nums
o5 = coeffs: {2059/64, 28, 3851/256, 3851/256, 2059/256}
     gens: {x^2*y^2-z^4, -(1/2)*x^3*y-(1/2)*x*y^3+x*y*z^2, ... }
i6 : first dens
     coeffs: {2059/64, 3851/256, 3851/256}
     gens: {x, y, z}
\end{verbatim}
}
The result consist of two sums of squares only, the second being the denominator.
Seeing this, one might get the idea that the product of $(x^{2}+y^{2}+z^{2})$ and the Motzkin polynomial is a sum of squares.
That this is the case can easily be checked with \verb|solveSOS (x^2+y^2+z^2)*f|.

% The \emph{Harris polynomial} is a ternary form with a record number zeros. 
% {\small
% \begin{verbatim}
% i3 : R = QQ[x,y,z]
% i4 : nonnegativeForm ("Harris", {x,y,z})

%         10      8 2      6 4      4 6      2 8      10      8 2      6 2 2      4 4 2
% o4 = 16x   - 36x y  + 20x y  + 20x y  - 36x y  + 16y   - 36x z  + 57x y z  - 38x y z  +
%      ----------------------------------------------------------------------------------
%         2 6 2      8 2      6 4      4 2 4      2 4 4      6 4      4 6      2 2 6
%      57x y z  - 36y z  + 20x z  - 38x y z  - 38x y z  + 20y z  + 20x z  + 57x y z  +
%      ----------------------------------------------------------------------------------
%         4 6      2 8      2 8      10
%      20y z  - 36x z  - 36y z  + 16z
% \end{verbatim}
% }

% At some point, SOS decompositions might be helpful in computing the
% real radical of an ideal.
% Namely,

\section{SOS optimization}

\subsection*{SOS problems with parameters}
Assume now that $f(x;p)$ is a polynomial function, that depends affinely on some parameters $p$.
The command \verb|solveSOS| allows to search for values of the parameters such that the polynomial is a SOS.
In the following example, the variable $t$ will be treated as a free parameter.
{\small
\begin{verbatim}
i7 : R = QQ[x][t];
i8 : f = (t-1)*x^4+1/2*t*x+1;
i9 : sol = solveSOS (f);
Running M2 Solver
Status: SDP solved, dual feasible
i10 : sosPoly(sol)
o10 = coeffs: {5/2, 7/4, 41/160}
      gens: {x^2  - 7/20, x - 1/2, 1}
i11 : sol#Parameters
o11 = {7/2}
\end{verbatim}
}

\subsection*{Parameter optimization}
It is also possible find the values of the parameters that optimize a given linear function.
This allows, in particular, to find lower bounds for a polynomial functions.
The following example finds a lower bound for the dehomogenized Motzkin polynomial $f(x)=x^4{+}x^2{+}z^6{-}3 x^2 z^2$, by finding the largest value of $t$ such that $f(x)-t$ is SOS.
{\small
\begin{verbatim}
i12 : R = QQ[x,z][t];
i13 : f = nonnegativeForm ("Motzkin", {x,1,z});
i14 : sol = solveSOS (f-t, -t, RoundTol=>12);
Running M2 Solver
Status: SDP solved, dual feasible
i15 : sol#Parameters
o15 = {- 729/4096}
\end{verbatim}
}
The function \verb|lowerBound| does this construction automatically.
{\small
\begin{verbatim}
i1 : R = QQ[x,z];
i2 : f = x^4+x^2+z^6-3*x^2*z^2;
i3 : (t,sol) = lowerBound (f, RoundTol=>12);
Running M2 Solver
Status: SDP solved, dual feasible
i16 : t
o16 = - 729/4096
\end{verbatim}
}

\subsection*{Rounding tolerance}
The methods \verb|solveSOS| and \verb|lowerBound| have an optional argument \verb|RoundTol|, which specifies the precision of the rational rounding.
Lower values of \verb|RoundTol| lead to simpler bounds (smaller denominators), at the expense of a loss in optimality.
We may also skip the rounding by setting it to infinity.
{\small
\begin{verbatim}
i14 : (t,sol) = lowerBound (f, RoundTol=>infinity);
Running M2 Solver
Status: SDP solved, dual feasible
i15 : t
o15 = - .177978892003352
\end{verbatim}
}

\subsection*{Polynomial optimization}

Consider the problem
\begin{align*}
  \min_{x\in X} \quad f(x),
  \quad \text{ where }\quad
  X := \{x \in \RR^n : h_1(x)=\dots=h_m(x)=0\},
\end{align*}
where $f, h_1,\dots,h_m$ are polynomials.
We can find lower SOS bounds for the optimal value.
The \SOS package gives two possible ways to do this.
The first method is to construct the associated quotient ring, and then call the method \verb|lowerBound|.
{\small
\begin{verbatim}
i6 : R = QQ[x,y]/ideal(x^2 - x, y^2 - y);
i7 : f = x - y;
i8 : (t,sol) = lowerBound(f,2);
Executing CSDP
Status: SDP solved, primal-dual feasible
i9 : t
o9 = -1
i10 : f - t == sosPoly sol
o10 = true
\end{verbatim}
}
The above method is appealing for relatively simple varieties, for which Gr\"obner bases computation is tractable.
For general varieties the quotient ring construction might be too expensive.
An alternative, is to call \verb|lowerBound| with the list of equations $h_1,\dots,h_m$.
The method will then look for polynomial multipliers $l_i(x)$ such that $f(x) - t + \sum_i l_i(x)h_i(x)$ is SOS.
{\small
\begin{verbatim}
i11 : R = QQ[x,y];
i12 : f = x - y;
i13 : h = matrix{{x^2 - x, y^2 - y}};
i14 : (t,sol,mult) = lowerBound (f, h, 2);
Executing CSDP
Status: SDP solved, primal-dual feasible
i15 : t
o15 = -1
i16 : f - t + h*mult == sumSOS sosPoly sol
o16 = true
\end{verbatim}
}



\section*{Acknowledgment}
\label{sec:acknowledgement}
The authors would like to thank the organizers and participants of the
\Mac\ workshop in May 2018 in Leipzig during which the renewal of the
SOS package started.

\bibliographystyle{amsplain}
\bibliography{sos}

\end{document}  

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
